{% extends "lab9/base1.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block style %}
<style>
    /* –¢–û–õ–¨–ö–û –°–¢–ò–õ–ò –î–õ–Ø –õ–ê–ë–û–†–ê–¢–û–†–ù–û–ô –†–ê–ë–û–¢–´ 9 */
    
    /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–æ–Ω –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    body {
        background: #ffffff !important;
    }
    
    /* –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã –¥–ª—è main –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ */
    main {
        max-width: none !important;
        padding: 0 !important;
        margin: 0 !important;
    }
    
    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–¥–∞—Ä–∫–æ–≤ */
    .header {
        text-align: center;
        color: #dc3545;
        padding: 30px 20px;
        margin: 20px auto;
        max-width: 1200px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 20px;
        border: 2px solid #dee2e6;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    }

    .header h1 {
        font-size: 2.5em;
        margin-bottom: 15px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        font-family: 'Georgia', serif;
    }

    /* –ö–Ω–æ–ø–∫–∞ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞ */
    .btn-santa-container {
        text-align: center;
        margin: 30px 0;
    }

    .btn-santa {
        background: linear-gradient(145deg, #dc3545, #fd7e14);
        color: white;
        border: none;
        padding: 16px 35px;
        border-radius: 50px;
        font-size: 1.2em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.25);
        min-width: 220px;
    }

    .btn-santa:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(220, 53, 69, 0.4);
    }

    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    .stats {
        background: #e3f2fd;
        padding: 20px;
        border-radius: 12px;
        margin: 20px auto;
        text-align: center;
        max-width: 500px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .counter {
        font-weight: bold;
        color: #dc3545;
        font-size: 1.3em;
    }

    /* –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –ü–û–î–ê–†–ö–û–í */
    .gift-container-wrapper {
        width: 100%;
        overflow-x: auto;
        padding: 20px 0;
    }

    .gift-container {
        position: relative;
        width: 1400px;
        height: 650px;
        margin: 0 auto;
        background: #f8f9fa;
        border-radius: 20px;
        border: 3px dashed #dee2e6;
        overflow: hidden;
        box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.05);
    }

    /* –°–¢–ò–õ–ò –î–õ–Ø –û–¢–î–ï–õ–¨–ù–´–• –ö–û–†–û–ë–û–ö */
    .gift-box {
        position: absolute !important;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 2;
        width: 120px;
        text-align: center;
        filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.1));
    }

    .gift-box:hover:not(.opened) {
        transform: scale(1.2) rotate(5deg);
        z-index: 100;
        filter: drop-shadow(0 10px 25px rgba(0, 0, 0, 0.2));
    }

    .gift-box.opened {
        opacity: 0.7;
        cursor: default;
    }

    .gift-box.opened:hover {
        transform: none !important;
    }

    .gift-box img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 10px;
        border: 3px solid #28a745;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
    }

    .gift-box:hover:not(.opened) img {
        transform: scale(1.1);
        border-color: #dc3545;
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
    }

    .gift-box.opened img {
        filter: grayscale(0.5);
        border-color: #6c757d;
    }

    .box-number {
        background: #495057;
        color: #ffffff;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: 600;
        display: inline-block;
        border: 2px solid #6c757d;
        margin-top: 8px;
        transition: all 0.3s ease;
    }

    .gift-box:hover:not(.opened) .box-number {
        background: #dc3545;
        border-color: #dc3545;
        transform: translateY(-2px);
    }

    /* –ò–∫–æ–Ω–∫–∞ –∑–∞–º–∫–∞ –¥–ª—è –∫–æ—Ä–æ–±–æ–∫, —Ç—Ä–µ–±—É—é—â–∏—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
    .requires-auth:before {
        content: 'üîí';
        position: absolute;
        top: -10px;
        right: -10px;
        background: #ffc107;
        color: #212529;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9em;
        box-shadow: 0 3px 8px rgba(255, 193, 7, 0.3);
        z-index: 3;
    }

    /* –ú–∞—Ä–∫–µ—Ä –æ—Ç–∫—Ä—ã—Ç–æ–π –∫–æ—Ä–æ–±–∫–∏ */
    .opened:after {
        content: '‚úì';
        position: absolute;
        top: -10px;
        left: -10px;
        background: #28a745;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        box-shadow: 0 3px 8px rgba(40, 167, 69, 0.3);
        font-size: 1em;
        z-index: 3;
    }

    /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
    @media (max-width: 1400px) {
        .gift-container {
            width: 100%;
            max-width: 1400px;
        }
    }

    @media (max-width: 768px) {
        .gift-container {
            width: 100%;
            height: 500px;
        }
        
        .gift-box {
            width: 100px;
        }
        
        .gift-box img {
            width: 80px;
            height: 80px;
        }
        
        .header h1 {
            font-size: 2em;
        }
    }
</style>
{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–æ—Ä–æ–±–∫–∞–º
        document.querySelectorAll('.gift-box:not(.opened)').forEach(box => {
            box.addEventListener('click', async function() {
                const id = this.dataset.id;
                
                const response = await fetch('/lab9/open_box', {
                    method: 'POST',
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ box_id: parseInt(id) })
                });
                
                const result = await response.json();
                
                if (result.limit_exceeded) {
                    alert("–í—ã —É–∂–µ –æ—Ç–∫—Ä—ã–ª–∏ 3 –∫–æ—Ä–æ–±–∫–∏!");
                    return;
                }
                
                if (result.auth_needed) {
                    alert("–≠—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.");
                    return;
                }
                
                if (result.already_opened) {
                    alert("–≠—Ç–∞ –∫–æ—Ä–æ–±–∫–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞!");
                    return;
                }
                
                if (result.success) {
                    window.location.href = result.redirect_url;
                }
            });
        });
        
        // –ö–Ω–æ–ø–∫–∞ –î–µ–¥–∞ –ú–æ—Ä–æ–∑–∞
        const resetBtn = document.getElementById('santa-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', async function() {
                if (!confirm('–î–µ–¥ –ú–æ—Ä–æ–∑ –Ω–∞–ø–æ–ª–Ω–∏—Ç –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏ –∑–∞–Ω–æ–≤–æ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                    return;
                }
                
                const response = await fetch('/lab9/reset_boxes', {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (result.success) {
                    window.location.reload();
                }
            });
        }
    });
</script>
{% endblock %}

{% block main %}
<h1 class="header">üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ü–æ–¥–∞—Ä–∫–∏ üéÅ</h1>

{% if current_user.is_authenticated %}
<div class="btn-santa-container">
    <button id="santa-btn" class="btn-santa">üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑</button>
</div>
{% endif %}

<div class="stats">
    <p>–ù–µ–æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–æ—Ä–æ–±–æ–∫: <span class="counter">{{ unopened_count }}/10</span></p>
    <p>–í—ã –æ—Ç–∫—Ä—ã–ª–∏: <span class="counter">{{ opened_in_session }}/3</span></p>
</div>

<div class="gift-container-wrapper">
    <div class="gift-container">
        {% for box in boxes %}
        <div class="gift-box {% if box.is_opened %}opened{% endif %} {% if box.auth_required %}requires-auth{% endif %}"
             data-id="{{ box.id }}"
             style="top: {{ box.pos_top }}px; left: {{ box.pos_left }}px;">
            
            <img src="/static/lab9/gift{{ box.id }}.jpg" 
                 alt="–ö–æ—Ä–æ–±–∫–∞ {{ box.id }}"
                 onerror="this.src='/static/lab9/default_gift.jpg'">
            
            <div class="box-number">#{{ box.id }}</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}