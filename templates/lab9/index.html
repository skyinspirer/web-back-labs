{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block style %}
{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.gift-box:not(.opened)').forEach(box => {
            box.addEventListener('click', async function() {
                const id = this.dataset.id;
                
                const response = await fetch('/lab9/open_box', {
                    method: 'POST',
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ box_id: parseInt(id) })
                });
                
                const result = await response.json();
                
                if (result.limit_exceeded) {
                    alert("–í—ã —É–∂–µ –æ—Ç–∫—Ä—ã–ª–∏ 3 –∫–æ—Ä–æ–±–∫–∏!");
                    return;
                }
                
                if (result.auth_needed) {
                    alert("–≠—Ç–æ—Ç –ø–æ–¥–∞—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.");
                    return;
                }
                
                if (result.already_opened) {
                    alert("–≠—Ç–∞ –∫–æ—Ä–æ–±–∫–∞ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–∞!");
                    return;
                }
                
                if (result.success) {
                    window.location.href = result.redirect_url;
                }
            });
        });
        
        const resetBtn = document.getElementById('santa-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', async function() {
                if (!confirm('–î–µ–¥ –ú–æ—Ä–æ–∑ –Ω–∞–ø–æ–ª–Ω–∏—Ç –≤—Å–µ –∫–æ—Ä–æ–±–∫–∏ –∑–∞–Ω–æ–≤–æ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                    return;
                }
                
                const response = await fetch('/lab9/reset_boxes', {
                    method: 'POST'
                });
                
                const result = await response.json();
                if (result.success) {
                    window.location.reload();
                }
            });
        }
    });
</script>
{% endblock %}

{% block main %}
<h1 class="header">üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ü–æ–¥–∞—Ä–∫–∏ üéÅ</h1>

{% if current_user.is_authenticated %}
<div style="text-align:center; margin:20px;">
    <button id="santa-btn" class="btn btn4">üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑</button>
</div>
{% endif %}

<div class="stats">
    <p>–ù–µ–æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–æ—Ä–æ–±–æ–∫: <span class="counter">{{ unopened_count }}/10</span></p>
    <p>–í—ã –æ—Ç–∫—Ä—ã–ª–∏: <span class="counter">{{ opened_in_session }}/3</span></p>
</div>

<div class="gift-container">
    {% for box in boxes %}
    <div class="gift-box {% if box.is_opened %}opened{% endif %} {% if box.auth_required %}requires-auth{% endif %}"
         data-id="{{ box.id }}"
         style="top: {{ box.pos_top }}px; left: {{ box.pos_left }}px;">
        
        <img src="/static/lab9/{{ box.id }}.png" alt="–ö–æ—Ä–æ–±–∫–∞ {{ box.id }}">
        
        {% if box.auth_required and not box.is_opened %}
        
        {% endif %}
        
        <div style="text-align:center;">#{{ box.id }}</div>
    </div>
    {% endfor %}
</div>
{% endblock %}