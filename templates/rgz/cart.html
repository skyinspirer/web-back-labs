{% extends "rgz/base.html" %}

{% block number_lab %}Корзина{% endblock %}

{% block main %}
    <h1>Корзина покупок</h1>
    
    <div id="cart-container">
        <p>Загрузка корзины...</p>
    </div>
    
    <div id="cart-total" class="cart-total">
        <!-- Здесь будет отображаться общая сумма -->
    </div>
    
    <div class="cart-actions">
        <button onclick="clearCart()" class="btn btn-danger">Очистить корзину</button>
        <a href="/rgz/checkout" class="btn btn-success">Оформить заказ</a>
        <a href="/rgz/" class="btn btn-secondary">Продолжить покупки</a>
    </div>

    <script>
        function loadCart() {
            fetch('/rgz/api', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    jsonrpc: '2.0',
                    method: 'get_cart',
                    params: {},
                    id: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('cart-container');
                
                if (!data.result || data.result.length === 0) {
                    container.innerHTML = '<p>Ваша корзина пуста</p>';
                    document.getElementById('cart-total').innerHTML = '';
                    return;
                }
                
                let html = `
                    <table class="cart-table">
                        <thead>
                            <tr>
                                <th>Товар</th>
                                <th>Цена</th>
                                <th>Количество</th>
                                <th>Сумма</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.result.forEach(item => {
                    const total = item.price * (item.quantity || 1);
                    html += `
                        <tr id="cart-item-${item.id}">
                            <td>
                                <strong>${item.name}</strong><br>
                                <small>${item.category}</small>
                            </td>
                            <td>${item.price} руб.</td>
                            <td>
                                <input type="number" min="1" value="${item.quantity || 1}" 
                                       id="qty-cart-${item.id}"
                                       onchange="updateQuantity(${item.id}, this.value)">
                            </td>
                            <td>${total} руб.</td>
                            <td>
                                <button onclick="removeFromCart(${item.id})" 
                                        class="btn btn-sm btn-danger">
                                    Удалить
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
                // Загружаем общую сумму
                loadCartTotal();
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('cart-container').innerHTML = 
                    '<p>Ошибка при загрузке корзины</p>';
            });
        }
        
        function loadCartTotal() {
            fetch('/rgz/api', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    jsonrpc: '2.0',
                    method: 'get_cart_total',
                    params: {},
                    id: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.result) {
                    document.getElementById('cart-total').innerHTML = `
                        <h3>Итого: ${data.result.total} руб.</h3>
                        <p>Количество товаров: ${data.result.item_count}</p>
                    `;
                }
            });
        }
        
        function removeFromCart(itemId) {
            if (!confirm('Удалить товар из корзины?')) return;
            
            fetch('/rgz/api', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    jsonrpc: '2.0',
                    method: 'remove_from_cart',
                    params: {item_id: itemId},
                    id: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.result && data.result.success) {
                    loadCart(); // Перезагружаем корзину
                } else if (data.error) {
                    alert('Ошибка: ' + data.error.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }
        
        function updateQuantity(itemId, quantity) {
            const qty = parseInt(quantity);
            if (qty < 1) {
                removeFromCart(itemId);
                return;
            }
            
            fetch('/rgz/api', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    jsonrpc: '2.0',
                    method: 'update_cart_item',
                    params: {item_id: itemId, quantity: qty},
                    id: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.result && data.result.success) {
                    loadCartTotal(); // Обновляем только сумму
                } else if (data.error) {
                    alert('Ошибка: ' + data.error.message);
                    loadCart(); // Перезагружаем корзину для восстановления правильного количества
                }
            })
            .catch(error => console.error('Error:', error));
        }
        
        function clearCart() {
            if (!confirm('Очистить всю корзину?')) return;
            
            fetch('/rgz/api', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    jsonrpc: '2.0',
                    method: 'clear_cart',
                    params: {},
                    id: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.result && data.result.success) {
                    loadCart(); // Перезагружаем корзину
                }
            })
            .catch(error => console.error('Error:', error));
        }
        
        // Загружаем корзину при открытии страницы
        document.addEventListener('DOMContentLoaded', loadCart);
    </script>

    <style>
        .cart-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .cart-table th, .cart-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        
        .cart-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .cart-total {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .cart-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        input[type="number"] {
            width: 70px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
{% endblock %}